---
const { title } = Astro.props;
---
<section class="topo-hero">
  <canvas id="topo-canvas" aria-hidden="true"></canvas>
  <div class="overlay">
    <div class="grid" aria-hidden="true"></div>
    <div class="frame" aria-hidden="true"></div>
    <div class="hud" aria-hidden="true">
      <span id="coord" class="coord mono">37.7749, -122.4194</span>
      <span class="compass n mono">N</span>
      <span class="compass e mono">E</span>
      <span class="compass s mono">S</span>
      <span class="compass w mono">W</span>
    </div>
  </div>
  <nav class="hero-nav" aria-label="Primary navigation">
    <div class="hero-nav__inner">
      <a href="/" class="brand" data-astro-prefetch>{title}</a>
      <ul>
        <li><a href="/work" data-astro-prefetch>Work</a></li>
        <li><a href="/blog" data-astro-prefetch>Blog</a></li>
        <li><a href="/lab" data-astro-prefetch>Lab</a></li>
        <li><a href="/about" data-astro-prefetch>About</a></li>
      </ul>
    </div>
  </nav>
  <script type="module" src="/topo.js"></script>
  <script type="module">
    const hero = document.querySelector('.topo-hero');
    const nav = hero ? hero.querySelector('.hero-nav') : null;
    if (!hero || !nav) return;

    const setNavHeight = () => {
      hero.style.setProperty('--nav-height', `${nav.offsetHeight}px`);
    };

    const onScroll = () => {
      const navHeight = nav.offsetHeight;
      if (window.scrollY > hero.offsetHeight - navHeight) {
        hero.classList.add('collapsed');
        nav.classList.add('sticky');
      } else {
        hero.classList.remove('collapsed');
        nav.classList.remove('sticky');
      }
    };

    const onResize = () => {
      setNavHeight();
      onScroll();
    };

    setNavHeight();
    onScroll();

    window.addEventListener('scroll', onScroll, { passive: true });
    window.addEventListener('resize', onResize);
  </script>
  <style>
    .topo-hero {
      position: relative;
      width: calc(100% - var(--space-4) * 2);
      /* Fill the viewport while preserving space for compass labels */
      height: calc(100vh - var(--space-4) * 2);
      height: calc(100svh - var(--space-4) * 2);
      margin: var(--space-4);
      --frame-color: var(--color-text);
      --grid-major: var(--accent-alpha-80);
      --grid-major: color-mix(in srgb, var(--color-accent) 80%, transparent);
      --grid-minor: var(--accent-alpha-40);
      --grid-minor: color-mix(in srgb, var(--color-accent) 40%, transparent);
      --contour-color: #000;
      --nav-height: 56px;
      background: var(--color-bg);
    }
    .topo-hero canvas {
      width: 100%;
      height: 100%;
      display: block;
      background: var(--color-bg);
    }
    .topo-hero .overlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }
    .topo-hero .grid {
      position: absolute;
      inset: 0;
      background-image:
        repeating-linear-gradient(var(--grid-minor) 0 1px, transparent 1px 16px),
        repeating-linear-gradient(90deg, var(--grid-minor) 0 1px, transparent 1px 16px),
        repeating-linear-gradient(var(--grid-major) 0 1px, transparent 1px 128px),
        repeating-linear-gradient(90deg, var(--grid-major) 0 1px, transparent 1px 128px);
    }
    .topo-hero .frame {
      position: absolute;
      inset: 0;
      border: 2px solid var(--frame-color);
    }
    .topo-hero .hud .coord {
      position: absolute;
      top: 4px;
      left: 4px;
      font-size: var(--text-12);
      color: var(--text-alpha-60);
      color: color-mix(in srgb, var(--frame-color) 60%, transparent);
    }
    .topo-hero .hud .compass {
      position: absolute;
      font-size: var(--text-12);
      color: var(--text-alpha-60);
      color: color-mix(in srgb, var(--frame-color) 60%, transparent);
    }
    .topo-hero .hud .n { top: -16px; left: 50%; transform: translateX(-50%); }
    .topo-hero .hud .s { bottom: -16px; left: 50%; transform: translateX(-50%); }
    .topo-hero .hud .e { right: -16px; top: 50%; transform: translateY(-50%); }
    .topo-hero .hud .w { left: -16px; top: 50%; transform: translateY(-50%); }
    .hero-nav {
      position: absolute;
      bottom: var(--space-2);
      left: 50%;
      transform: translateX(-50%);
      width: min(calc(100% - var(--space-4) * 2), var(--layout-max-width-wide));
      color: var(--frame-color);
      background: var(--color-bg);
      border: 2px solid var(--frame-color);
      border-radius: 0;
      padding: var(--space-1);
      transition: box-shadow var(--transition-base), border-color var(--transition-base);
    }
    .hero-nav__inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-2);
      padding: 0 var(--space-2);
    }
    .hero-nav__inner ul {
      display: flex;
      gap: var(--space-2);
      list-style: none;
      margin: 0;
      padding: 0;
    }
    .hero-nav__inner a {
      color: inherit;
      text-decoration: none;
      font-weight: 800;
    }
    .hero-nav__inner a:focus-visible,
    .hero-nav__inner a:hover {
      color: var(--color-accent);
    }
    .hero-nav ul {
      font-size: var(--text-14);
    }
    .hero-nav .brand {
      font-size: clamp(var(--text-24), 5vw, var(--text-48));
      letter-spacing: 0.1em;
      text-transform: uppercase;
      font-weight: 900;
    }
    .hero-nav li a {
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }
    .hero-nav.sticky {
      position: fixed;
      top: 0;
      left: 50%;
      right: auto;
      transform: translateX(-50%);
      width: min(calc(100% - var(--space-4) * 2), var(--layout-max-width-wide));
      background: color-mix(in srgb, var(--color-bg) 96%, transparent);
      border-radius: 0;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      border-color: var(--color-rule);
      backdrop-filter: blur(8px);
      z-index: 1000;
    }
    .hero-nav.sticky .hero-nav__inner {
      padding-block: var(--space-1);
    }
    .topo-hero.collapsed {
      height: var(--nav-height);
      max-height: var(--nav-height);
      aspect-ratio: auto;
    }

    @media (max-width: 600px) {
      .hero-nav {
        width: calc(100% - var(--space-2) * 2);
        padding: var(--space-1);
      }
      .hero-nav__inner {
        flex-direction: column;
        align-items: flex-start;
        width: 100%;
      }
      .hero-nav ul {
        flex-direction: column;
        width: 100%;
      }
      .hero-nav li {
        width: 100%;
      }
      .hero-nav a {
        display: inline-block;
        width: 100%;
      }
      .hero-nav .brand {
        letter-spacing: 0.12em;
      }
      .hero-nav.sticky {
        width: calc(100% - var(--space-2) * 2);
      }
    }
  </style>
</section>
