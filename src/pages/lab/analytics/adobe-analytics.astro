---
import Layout from '../../../layouts/Layout.astro';
import '../../../styles/analytics-sandbox.css';
---
<Layout title="Adobe Analytics Sandbox">
  <div class="container analytics-sandbox adobe-sandbox">
    <header class="sandbox-header hairline-bottom">
      <p class="supertitle mono">Analytics Lab / Instrumentation</p>
      <h1>Adobe Analytics Sandbox</h1>
      <p class="intro">
        Explore how AppMeasurement tracking fires across a miniature mission control interface. Engage the
        components on the left and observe the simulated beacon payloads rendered in the console.
      </p>
      <dl class="sandbox-meta">
        <div>
          <dt>Report suite</dt>
          <dd class="mono">jwiedeman.sandbox</dd>
        </div>
        <div>
          <dt>Endpoint</dt>
          <dd class="mono">https://metrics-demo.sc.omtrdc.net/b/ss/.../s</dd>
        </div>
      </dl>
    </header>

    <div class="sandbox-grid">
      <section class="sandbox-panel">
        <article class="sandbox-card adobe-card" aria-labelledby="adobe-cta-title">
          <header>
            <p id="adobe-cta-title" class="sandbox-card__tag mono">linkName: cta:launch-sequence · linkType: o</p>
            <h3>Primary CTA — Launch sequence</h3>
          </header>
          <p>
            Demonstrates a high-priority interaction within mission controls. The payload forwards event,
            prop, eVar, and contextData bindings typical of conversion CTAs.
          </p>
          <dl class="sandbox-card__meta">
            <div>
              <dt>events</dt>
              <dd class="mono">event5</dd>
            </div>
            <div>
              <dt>prop4</dt>
              <dd class="mono">launch:cta</dd>
            </div>
            <div>
              <dt>eVar4</dt>
              <dd class="mono">Launch — Primary</dd>
            </div>
            <div>
              <dt>contextData</dt>
              <dd class="mono">component=mission-controls · priority=primary</dd>
            </div>
          </dl>
          <button
            id="aa-primary-cta"
            class="sandbox-action"
            data-aa-component="mission-controls"
            data-aa-role="primary-cta"
            type="button"
          >
            Initiate launch
          </button>
          <pre class="adobe-code mono">{`s.tl(this, 'o', 'cta:launch-sequence', { events: 'event5', prop4: 'launch:cta', eVar4: 'Launch — Primary', contextData: { component: 'mission-controls', priority: 'primary' } });`}</pre>
        </article>

        <article class="sandbox-card adobe-card" aria-labelledby="adobe-link-title">
          <header>
            <p id="adobe-link-title" class="sandbox-card__tag mono">linkName: nav:telemetry-logs · linkType: o</p>
            <h3>Secondary link — Telemetry logs</h3>
          </header>
          <p>
            Mirrors navigation link tracking with module metadata and contextData to label destination
            hierarchies.
          </p>
          <dl class="sandbox-card__meta">
            <div>
              <dt>events</dt>
              <dd class="mono">event8</dd>
            </div>
            <div>
              <dt>prop6</dt>
              <dd class="mono">nav:telemetry</dd>
            </div>
            <div>
              <dt>eVar6</dt>
              <dd class="mono">Navigation Link</dd>
            </div>
            <div>
              <dt>contextData</dt>
              <dd class="mono">component=global-nav · destination=telemetry</dd>
            </div>
          </dl>
          <a
            id="aa-secondary-link"
            class="sandbox-link"
            href="#"
            data-aa-component="global-nav"
            data-aa-role="secondary-link"
          >
            View telemetry logs
          </a>
          <pre class="adobe-code mono">{`s.tl(this, 'o', 'nav:telemetry-logs', { events: 'event8', prop6: 'nav:telemetry', eVar6: 'Navigation Link', contextData: { component: 'global-nav', destination: 'telemetry' } });`}</pre>
        </article>

        <article class="sandbox-card adobe-card" aria-labelledby="adobe-form-title">
          <header>
            <p id="adobe-form-title" class="sandbox-card__tag mono">linkName: form:telemetry-upload · linkType: o</p>
            <h3>Telemetry upload form</h3>
          </header>
          <p>
            Captures a structured form submission including mission ID and channel selections. Prevents
            default submission so you can inspect the payload inline.
          </p>
          <dl class="sandbox-card__meta">
            <div>
              <dt>events</dt>
              <dd class="mono">event12</dd>
            </div>
            <div>
              <dt>prop9</dt>
              <dd class="mono">form:telemetry</dd>
            </div>
            <div>
              <dt>eVar9</dt>
              <dd class="mono">Telemetry Upload</dd>
            </div>
            <div>
              <dt>contextData</dt>
              <dd class="mono">component=telemetry · submission=form</dd>
            </div>
          </dl>
          <form
            id="aa-telemetry-form"
            class="sandbox-form"
            data-aa-component="telemetry"
            data-aa-role="form"
          >
            <label for="aa-telemetry-id">Mission ID</label>
            <input id="aa-telemetry-id" name="missionId" type="text" placeholder="e.g. apollo-204" required />
            <label for="aa-telemetry-channel">Channel</label>
            <select id="aa-telemetry-channel" name="channel">
              <option value="orbital">Orbital</option>
              <option value="lunar">Lunar</option>
              <option value="deep-space">Deep space</option>
            </select>
            <button class="sandbox-action" type="submit">Upload telemetry packet</button>
          </form>
          <pre class="adobe-code mono">{`s.tl(this, 'o', 'form:telemetry-upload', { events: 'event12', prop9: 'form:telemetry', eVar9: 'Telemetry Upload', contextData: { component: 'telemetry', submission: 'form' } });`}</pre>
        </article>

        <section class="sandbox-card adobe-card adobe-pageview" aria-labelledby="adobe-pageview-title">
          <h2 id="adobe-pageview-title">Page load variables</h2>
          <p>
            Initial <code>s.t()</code> call seeds persistent classification variables for this sandbox view.
            These values frame the report suite, channel, and template metadata.
          </p>
          <ul class="sandbox-list mono">
            <li>pageName = lab:analytics:adobe-analytics</li>
            <li>channel = lab</li>
            <li>eVar1 = Adobe Analytics Sandbox</li>
            <li>prop1 = lab:analytics</li>
            <li>events = event1</li>
            <li>contextData.page.missionPhase = demo</li>
            <li>contextData.page.template = sandbox</li>
          </ul>
          <pre class="adobe-code mono">{`s.t({ pageName: 'lab:analytics:adobe-analytics', channel: 'lab', events: 'event1', prop1: 'lab:analytics', eVar1: 'Adobe Analytics Sandbox', contextData: { 'page.missionPhase': 'demo', 'page.template': 'sandbox' } });`}</pre>
        </section>
      </section>

      <aside class="sandbox-console adobe-console" data-console-panel aria-labelledby="adobe-console-heading">
        <h2 id="adobe-console-heading">Beacon payloads</h2>
        <p>
          Simulated requests to <code class="mono">https://metrics-demo.sc.omtrdc.net/b/ss/jwiedeman.sandbox/1/JS-2.23.0/s</code>.
          Entries render the raw query string along with the structured JSON payload.
        </p>
        <div class="sandbox-console__toolbar" role="group" aria-label="Adobe Analytics console controls">
          <button type="button" class="console-control" data-console-scroll disabled>Jump to latest</button>
          <button type="button" class="console-control" data-console-clear disabled>Clear console</button>
        </div>
        <div
          class="console-stream"
          data-console-stream
          role="log"
          aria-live="polite"
          aria-relevant="additions"
          tabindex="0"
        >
          <p class="console-empty" data-console-empty>Awaiting Adobe Analytics activity…</p>
        </div>
        <noscript>
          <p class="console-empty">Enable JavaScript to observe the simulated beacon output.</p>
        </noscript>
      </aside>
    </div>
  </div>

  <script type="module">
    const endpoint = 'https://metrics-demo.sc.omtrdc.net/b/ss/jwiedeman.sandbox/1/JS-2.23.0/s';
    const MAX_ENTRIES = 8;

    function createSandboxConsole({ limit = MAX_ENTRIES } = {}) {
      const panel = document.querySelector('[data-console-panel]');
      const stream = panel ? panel.querySelector('[data-console-stream]') : null;
      const empty = stream ? stream.querySelector('[data-console-empty]') : null;
      const clearButton = panel ? panel.querySelector('[data-console-clear]') : null;
      const scrollButton = panel ? panel.querySelector('[data-console-scroll]') : null;

      if (!panel || !stream) {
        return null;
      }

      const hideEmpty = () => {
        if (empty) {
          empty.hidden = true;
        }
      };

      const showEmpty = () => {
        if (empty) {
          empty.hidden = false;
        }
      };

      const updateControls = () => {
        const hasEntries = !!stream.querySelector('.console-entry');
        if (clearButton) {
          clearButton.disabled = !hasEntries;
        }
        if (scrollButton) {
          scrollButton.disabled = !hasEntries;
        }
      };

      const focusPanel = () => {
        const rect = panel.getBoundingClientRect();
        const fullyVisible = rect.top >= 0 && rect.bottom <= window.innerHeight;
        if (!fullyVisible) {
          panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      };

      if (clearButton) {
        clearButton.addEventListener('click', () => {
          stream.querySelectorAll('.console-entry').forEach((entry) => entry.remove());
          showEmpty();
          updateControls();
          if (typeof stream.scrollTo === 'function') {
            stream.scrollTo({ top: 0, behavior: 'smooth' });
          } else {
            stream.scrollTop = 0;
          }
          if (typeof stream.focus === 'function') {
            stream.focus();
          }
        });
      }

      if (scrollButton) {
        scrollButton.addEventListener('click', () => {
          focusPanel();
          if (typeof stream.scrollTo === 'function') {
            stream.scrollTo({ top: 0, behavior: 'smooth' });
          } else {
            stream.scrollTop = 0;
          }
        });
      }

      updateControls();

      return {
        append(entry) {
          hideEmpty();
          entry.classList.add('console-entry--recent');
          entry.addEventListener(
            'animationend',
            () => entry.classList.remove('console-entry--recent'),
            { once: true }
          );
          stream.prepend(entry);
          const entries = Array.from(stream.querySelectorAll('.console-entry'));
          if (limit && entries.length > limit) {
            entries.slice(limit).forEach((oldEntry) => oldEntry.remove());
          }
          updateControls();
          if (typeof stream.scrollTo === 'function') {
            stream.scrollTo({ top: 0, behavior: 'smooth' });
          } else {
            stream.scrollTop = 0;
          }
          focusPanel();
        }
      };
    }

    const consoleUI = createSandboxConsole({ limit: MAX_ENTRIES });

    const buildPayload = (linkName, linkType, attributes) => {
      const query = new URLSearchParams({
        AQB: '1',
        AQE: '1',
        pe: linkType,
        pev2: linkName,
        ...attributes
      });

      return {
        method: 'GET',
        summary: `${linkType.toUpperCase()} · ${linkName}`,
        request: `${endpoint}?${query.toString()}`,
        data: {
          linkName,
          linkType,
          ...attributes
        }
      };
    };

    const logPayload = (payload) => {
      if (!consoleUI) {
        return;
      }
      const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false });
      const entry = document.createElement('article');
      entry.className = 'console-entry';
      entry.innerHTML = `
        <header class="console-entry__meta">
          <span class="console-entry__method">${payload.method}</span>
          <span>${payload.summary}</span>
          <span>${timestamp}</span>
        </header>
        <pre class="console-entry__body">${payload.request}</pre>
        <pre class="console-entry__body">${JSON.stringify(payload.data, null, 2)}</pre>
      `;
      consoleUI.append(entry);
    };

    const fireLinkTracking = (linkName, linkType, attributes) => {
      const payload = buildPayload(linkName, linkType, attributes);
      logPayload(payload);
    };

    const bindingMap = {
      cta: {
        linkName: 'cta:launch-sequence',
        linkType: 'o',
        attributes: {
          events: 'event5',
          prop4: 'launch:cta',
          eVar4: 'Launch — Primary',
          'contextData.component': 'mission-controls',
          'contextData.priority': 'primary'
        }
      },
      nav: {
        linkName: 'nav:telemetry-logs',
        linkType: 'o',
        attributes: {
          events: 'event8',
          prop6: 'nav:telemetry',
          eVar6: 'Navigation Link',
          'contextData.component': 'global-nav',
          'contextData.destination': 'telemetry'
        }
      },
      form: {
        linkName: 'form:telemetry-upload',
        linkType: 'o',
        attributes: {
          events: 'event12',
          prop9: 'form:telemetry',
          eVar9: 'Telemetry Upload',
          'contextData.component': 'telemetry',
          'contextData.submission': 'form'
        }
      }
    };

    document.getElementById('aa-primary-cta')?.addEventListener('click', () => {
      fireLinkTracking(bindingMap.cta.linkName, bindingMap.cta.linkType, bindingMap.cta.attributes);
    });

    document.getElementById('aa-secondary-link')?.addEventListener('click', (event) => {
      event.preventDefault();
      fireLinkTracking(bindingMap.nav.linkName, bindingMap.nav.linkType, bindingMap.nav.attributes);
    });

    document.getElementById('aa-telemetry-form')?.addEventListener('submit', (event) => {
      event.preventDefault();
      fireLinkTracking(bindingMap.form.linkName, bindingMap.form.linkType, bindingMap.form.attributes);
      event.currentTarget.reset();
    });

    const pageViewPayload = buildPayload('page:view', 't', {
      events: 'event1',
      pageName: 'lab:analytics:adobe-analytics',
      channel: 'lab',
      prop1: 'lab:analytics',
      eVar1: 'Adobe Analytics Sandbox',
      'contextData.page.missionPhase': 'demo',
      'contextData.page.template': 'sandbox'
    });
    logPayload(pageViewPayload);
  </script>

  <style>
    .adobe-sandbox .adobe-card pre.adobe-code {
      margin: 0;
      padding: var(--space-2);
      border: 1px solid var(--color-rule);
      border-radius: var(--radius-2);
      background: rgba(0, 0, 0, 0.04);
      overflow-x: auto;
      font-size: var(--text-12);
      line-height: 1.4;
    }

    .adobe-sandbox .adobe-console {
      gap: var(--space-2);
    }
  </style>
</Layout>
