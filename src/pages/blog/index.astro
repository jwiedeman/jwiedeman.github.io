---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

const allPosts = (await getCollection('blog')).sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
const featured = allPosts.find(p => p.data.featured);
const posts = featured ? allPosts.filter(p => p.id !== featured.id) : allPosts;
const tags = Array.from(new Set(allPosts.flatMap(p => p.data.tags))).sort();
const postsPerPage = 6;
const totalPostCount = posts.length + (featured ? 1 : 0);

// Format date with leading zeros
function formatDate(date: Date) {
  const y = date.getFullYear();
  const m = String(date.getMonth() + 1).padStart(2, '0');
  const d = String(date.getDate()).padStart(2, '0');
  return `${y}.${m}.${d}`;
}
---
<Layout title="Blog">
  <div class="blog-page">
    <!-- Header -->
    <header class="blog-header">
      <div class="blog-header__meta">
        <span class="section-index">Archive</span>
        <span class="classification classification--accent">Public</span>
      </div>
      <h1 class="blog-header__title">Signal<br/>Log</h1>
      <p class="blog-header__subtitle">Transmissions & Dispatches</p>
    </header>

    <!-- Search & Filters -->
    <section class="blog-controls">
      <div class="blog-controls__search">
        <span class="search-label mono">QUERY //</span>
        <input id="search" type="search" class="search-input" placeholder="Search archives..." />
      </div>
      <div class="blog-controls__tags">
        <span class="tags-label mono">FILTER //</span>
        <div class="tags-list">
          {tags.map(tag => <button class="tag-btn" data-tag={tag}>{tag}</button>)}
        </div>
      </div>
    </section>

    <!-- Status Bar -->
    <div class="status-bar">
      <span class="status-bar__count mono" id="results-status" role="status" aria-live="polite" data-empty-message="No entries match current filters.">
        {totalPostCount} {totalPostCount === 1 ? 'RECORD' : 'RECORDS'} INDEXED
      </span>
      <span class="status-bar__line"></span>
    </div>

    <!-- Featured Post -->
    {featured && (
      <section class="featured-section">
        <div class="section-label">
          <span class="section-index">01</span>
          <span class="section-title mono">FEATURED ENTRY</span>
        </div>
        <article class="featured-post" data-tags={featured.data.tags.join(',')} data-title={featured.data.title.toLowerCase()} data-description={featured.data.description.toLowerCase()}>
          <div class="featured-post__header">
            <span class="post-id mono">DOC-000</span>
            <span class="post-date mono">{formatDate(featured.data.pubDate)}</span>
          </div>
          <div class="featured-post__body">
            <h2 class="featured-post__title">
              <a href={`/blog/${featured.slug}/`}>{featured.data.title}</a>
            </h2>
            <p class="featured-post__excerpt">{featured.data.description}</p>
            <div class="featured-post__tags">
              {featured.data.tags.map(tag => <span class="post-tag mono">{tag}</span>)}
            </div>
          </div>
          <div class="featured-post__action">
            <a href={`/blog/${featured.slug}/`} class="read-btn mono">ACCESS →</a>
          </div>
        </article>
      </section>
    )}

    <!-- Posts Grid -->
    <section class="posts-section">
      <div class="section-label">
        <span class="section-index">{featured ? '02' : '01'}</span>
        <span class="section-title mono">ARCHIVE INDEX</span>
      </div>

      <div id="posts" class="posts-grid" data-posts-per-page={postsPerPage}>
        {posts.map((post, i) => (
          <article class="post-card" data-tags={post.data.tags.join(',')} data-title={post.data.title.toLowerCase()} data-description={post.data.description.toLowerCase()}>
            <div class="post-card__header">
              <span class="post-id mono">DOC-{String(i + 1).padStart(3, '0')}</span>
              <span class="post-date mono">{formatDate(post.data.pubDate)}</span>
            </div>
            <h3 class="post-card__title">
              <a href={`/blog/${post.slug}/`}>{post.data.title}</a>
            </h3>
            <p class="post-card__excerpt">{post.data.description}</p>
            <div class="post-card__footer">
              <div class="post-card__tags">
                {post.data.tags.map(tag => <span class="post-tag mono">{tag}</span>)}
              </div>
              <a href={`/blog/${post.slug}/`} class="post-card__link mono">→</a>
            </div>
          </article>
        ))}
      </div>

      <div id="pagination" class="pagination"></div>
    </section>
  </div>

  <script>
    function init() {
      const postsContainer = document.getElementById('posts');
      if (!postsContainer) return;

      const posts = Array.from(postsContainer.querySelectorAll('.post-card'));
      const featuredSection = document.querySelector('.featured-section');
      const featuredCard = featuredSection ? featuredSection.querySelector('.featured-post') : null;
      const filterableCards = featuredCard ? [...posts, featuredCard] : [...posts];
      const POSTS_PER_PAGE = parseInt(postsContainer.dataset.postsPerPage || '6', 10);
      let currentPage = 1;
      const selectedTags = new Set();

      const searchInput = document.getElementById('search');
      const tagButtons = document.querySelectorAll('.tag-btn');
      const pagination = document.getElementById('pagination');
      const status = document.getElementById('results-status');
      const emptyMessage = status && status.dataset ? status.dataset.emptyMessage || 'No entries found.' : 'No entries found.';

      const searchableCache = new Map(
        filterableCards.map(card => [
          card,
          [card.dataset.title || '', card.dataset.description || '', card.dataset.tags || '']
            .join(' ')
            .toLowerCase(),
        ]),
      );

      function updateFeaturedVisibility() {
        if (!featuredSection || !featuredCard) return;
        (featuredSection as HTMLElement).hidden = (featuredCard as HTMLElement).hidden;
      }

      function updateStatus(visiblePostCount: number) {
        if (!status) return;
        const query = (searchInput ? (searchInput as HTMLInputElement).value : '').trim();
        const activeTags = [...selectedTags];
        const featuredVisible = featuredCard && !(featuredCard as HTMLElement).hidden ? 1 : 0;
        const totalVisible = visiblePostCount + featuredVisible;

        if (totalVisible === 0) {
          status.textContent = emptyMessage;
          return;
        }

        const descriptors: string[] = [];
        if (query) descriptors.push(`matching "${query}"`);
        if (activeTags.length) descriptors.push(`tagged ${activeTags.join(', ')}`);

        const suffix = descriptors.length ? ` ${descriptors.join(' and ')}` : ' INDEXED';
        status.textContent = `${totalVisible} ${totalVisible === 1 ? 'RECORD' : 'RECORDS'}${suffix.toUpperCase()}`;
      }

      function filterPosts() {
        const query = (searchInput ? (searchInput as HTMLInputElement).value : '').trim().toLowerCase();

        filterableCards.forEach(card => {
          const searchable = searchableCache.get(card) || '';
          const matchesSearch = !query || searchable.includes(query);
          const tags = ((card as HTMLElement).dataset.tags || '')
            .split(',')
            .map(t => t.trim())
            .filter(Boolean);
          const matchesTags = !selectedTags.size || [...selectedTags].every(tag => tags.includes(tag as string));
          (card as HTMLElement).hidden = !(matchesSearch && matchesTags);
        });

        updateFeaturedVisibility();
        currentPage = 1;
        paginate();
      }

      function paginate() {
        const visiblePosts = posts.filter(post => !(post as HTMLElement).hidden);
        const totalPages = Math.ceil(visiblePosts.length / POSTS_PER_PAGE) || 1;
        const start = (currentPage - 1) * POSTS_PER_PAGE;
        const end = start + POSTS_PER_PAGE;

        posts.forEach(post => {
          (post as HTMLElement).style.display = (post as HTMLElement).hidden ? 'none' : '';
        });

        visiblePosts.forEach((post, index) => {
          if (index < start || index >= end) {
            (post as HTMLElement).style.display = 'none';
          }
        });

        if (pagination) {
          pagination.innerHTML = '';

          if (visiblePosts.length > POSTS_PER_PAGE) {
            for (let i = 1; i <= totalPages; i++) {
              const btn = document.createElement('button');
              btn.type = 'button';
              btn.textContent = String(i).padStart(2, '0');
              btn.className = 'page-btn mono' + (i === currentPage ? ' active' : '');
              btn.addEventListener('click', () => {
                currentPage = i;
                paginate();
              });
              pagination.appendChild(btn);
            }
          }
        }

        updateStatus(visiblePosts.length);
      }

      if (searchInput) {
        searchInput.addEventListener('input', filterPosts);
      }
      tagButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const tag = (btn as HTMLElement).dataset.tag;
          if (!tag) return;
          if (selectedTags.has(tag)) {
            selectedTags.delete(tag);
            btn.classList.remove('active');
            btn.setAttribute('aria-pressed', 'false');
          } else {
            selectedTags.add(tag);
            btn.classList.add('active');
            btn.setAttribute('aria-pressed', 'true');
          }
          filterPosts();
        });
        btn.setAttribute('aria-pressed', 'false');
        btn.setAttribute('type', 'button');
      });

      filterPosts();
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</Layout>

<style>
  .blog-page {
    max-width: 56rem;
    margin: 0 auto;
    padding: var(--space-5) var(--page-inline);
  }

  /* Header */
  .blog-header {
    padding: var(--space-6) 0 var(--space-5);
    border-bottom: 2px solid var(--color-text);
    margin-bottom: var(--space-5);
  }

  .blog-header__meta {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    margin-bottom: var(--space-4);
  }

  .blog-header__title {
    font-size: clamp(2.5rem, 10vw, 4.5rem);
    font-weight: 800;
    line-height: 0.9;
    letter-spacing: -0.04em;
    text-transform: uppercase;
    margin-bottom: var(--space-2);
  }

  .blog-header__subtitle {
    font-family: var(--font-mono);
    font-size: var(--text-14);
    font-weight: 400;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: var(--color-accent);
  }

  /* Controls */
  .blog-controls {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
    padding: var(--space-4) 0;
    border-bottom: 1px solid var(--border-faint);
  }

  .blog-controls__search {
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }

  .search-label {
    font-size: var(--text-10);
    color: var(--color-muted);
    letter-spacing: 0.1em;
    flex-shrink: 0;
  }

  .search-input {
    flex: 1;
    background: transparent;
    border: none;
    border-bottom: 1px solid var(--border-faint);
    padding: var(--space-2) 0;
    font-family: var(--font-mono);
    font-size: var(--text-12);
    color: var(--color-text);
    letter-spacing: 0.02em;
    outline: none;
    transition: border-color 0.2s ease;
  }

  .search-input:focus {
    border-color: var(--color-accent);
  }

  .search-input::placeholder {
    color: var(--color-muted);
    opacity: 0.6;
  }

  .blog-controls__tags {
    display: flex;
    align-items: flex-start;
    gap: var(--space-2);
  }

  .tags-label {
    font-size: var(--text-10);
    color: var(--color-muted);
    letter-spacing: 0.1em;
    flex-shrink: 0;
    padding-top: var(--space-1);
  }

  .tags-list {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-1);
  }

  .tag-btn {
    font-family: var(--font-mono);
    font-size: var(--text-9);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: var(--space-1) var(--space-2);
    background: transparent;
    border: 1px solid var(--border-faint);
    color: var(--color-muted);
    cursor: pointer;
    transition: all 0.15s ease;
  }

  .tag-btn:hover {
    border-color: var(--color-accent);
    color: var(--color-accent);
  }

  .tag-btn.active {
    background: var(--color-accent);
    border-color: var(--color-accent);
    color: var(--color-bg);
  }

  /* Status Bar */
  .status-bar {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-4) 0;
  }

  .status-bar__count {
    font-size: var(--text-10);
    letter-spacing: 0.15em;
    color: var(--color-muted);
    flex-shrink: 0;
  }

  .status-bar__line {
    flex: 1;
    height: 1px;
    background: var(--border-faint);
  }

  /* Section Label */
  .section-label {
    display: flex;
    align-items: baseline;
    gap: var(--space-3);
    margin-bottom: var(--space-4);
  }

  .section-title {
    font-size: var(--text-11);
    letter-spacing: 0.2em;
    color: var(--color-muted);
  }

  /* Featured Post */
  .featured-section {
    padding: var(--space-5) 0;
    border-bottom: 1px solid var(--border-faint);
  }

  .featured-post {
    border: 1px solid var(--color-text);
    border-left: 4px solid var(--color-accent);
  }

  .featured-post__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-2) var(--space-3);
    background: var(--surface-panel);
    border-bottom: 1px solid var(--border-faint);
  }

  .post-id {
    font-size: var(--text-9);
    letter-spacing: 0.1em;
    color: var(--color-accent);
  }

  .post-date {
    font-size: var(--text-9);
    letter-spacing: 0.1em;
    color: var(--color-muted);
  }

  .featured-post__body {
    padding: var(--space-4);
  }

  .featured-post__title {
    font-size: var(--text-24);
    font-weight: 700;
    line-height: 1.2;
    text-transform: uppercase;
    letter-spacing: 0.01em;
    margin-bottom: var(--space-3);
  }

  .featured-post__title a {
    color: inherit;
    text-decoration: none;
    border-bottom: none;
    transition: color 0.2s ease;
  }

  .featured-post__title a:hover {
    color: var(--color-accent);
  }

  .featured-post__excerpt {
    font-size: var(--text-14);
    line-height: 1.7;
    color: var(--color-muted);
    margin-bottom: var(--space-3);
  }

  .featured-post__tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-1);
  }

  .post-tag {
    font-size: var(--text-8);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 2px var(--space-1);
    background: var(--surface-tint);
    color: var(--color-muted);
  }

  .featured-post__action {
    padding: var(--space-2) var(--space-3);
    border-top: 1px solid var(--border-faint);
    background: var(--surface-panel);
  }

  .read-btn {
    font-size: var(--text-10);
    letter-spacing: 0.15em;
    color: var(--color-accent);
    text-decoration: none;
    border-bottom: none;
    transition: opacity 0.2s ease;
  }

  .read-btn:hover {
    opacity: 0.7;
  }

  /* Posts Grid */
  .posts-section {
    padding: var(--space-5) 0;
  }

  .posts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(16rem, 1fr));
    gap: var(--space-4);
  }

  .post-card {
    display: flex;
    flex-direction: column;
    border: 1px solid var(--border-faint);
    transition: border-color 0.2s ease;
  }

  .post-card:hover {
    border-color: var(--color-accent);
  }

  .post-card__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-2) var(--space-3);
    border-bottom: 1px solid var(--border-faint);
  }

  .post-card__title {
    font-size: var(--text-14);
    font-weight: 600;
    line-height: 1.3;
    text-transform: uppercase;
    letter-spacing: 0.02em;
    padding: var(--space-3);
    padding-bottom: var(--space-2);
  }

  .post-card__title a {
    color: inherit;
    text-decoration: none;
    border-bottom: none;
    transition: color 0.2s ease;
  }

  .post-card__title a:hover {
    color: var(--color-accent);
  }

  .post-card__excerpt {
    font-size: var(--text-12);
    line-height: 1.6;
    color: var(--color-muted);
    padding: 0 var(--space-3);
    flex: 1;
  }

  .post-card__footer {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    padding: var(--space-3);
    padding-top: var(--space-2);
    margin-top: auto;
  }

  .post-card__tags {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
  }

  .post-card__link {
    font-size: var(--text-14);
    color: var(--color-accent);
    text-decoration: none;
    border-bottom: none;
    transition: transform 0.2s ease;
    display: inline-block;
  }

  .post-card__link:hover {
    transform: translateX(4px);
  }

  /* Pagination */
  .pagination {
    display: flex;
    justify-content: center;
    gap: var(--space-1);
    margin-top: var(--space-5);
  }

  .page-btn {
    width: 2.5rem;
    height: 2.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: var(--font-mono);
    font-size: var(--text-11);
    letter-spacing: 0.05em;
    background: transparent;
    border: 1px solid var(--border-faint);
    color: var(--color-muted);
    cursor: pointer;
    transition: all 0.15s ease;
  }

  .page-btn:hover {
    border-color: var(--color-accent);
    color: var(--color-accent);
  }

  .page-btn.active {
    background: var(--color-accent);
    border-color: var(--color-accent);
    color: var(--color-bg);
  }

  /* Responsive */
  @media (max-width: 640px) {
    .blog-controls__search,
    .blog-controls__tags {
      flex-direction: column;
      align-items: stretch;
    }

    .search-label,
    .tags-label {
      margin-bottom: var(--space-1);
    }

    .posts-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
